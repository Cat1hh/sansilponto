<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ponto - Sansil</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary-red: #E30613; 
            --dark-bg: #1a1a1a;
            --light-bg: #f4f4f4;
            --white: #ffffff;
            --gray: #333;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--dark-bg);
            margin: 0;
            color: var(--white);
            min-height: 100vh;
        }

        .hidden { display: none !important; }

        /* Container Principal */
        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            width: 100%;
            padding: 20px;
        }

        .card-box {
            background: var(--white);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 400px;
            color: var(--gray);
            text-align: center;
        }

        h2 {
            color: var(--primary-red);
            text-transform: uppercase;
            font-weight: 900;
            border-bottom: 3px solid var(--primary-red);
            padding-bottom: 10px;
            margin-bottom: 25px;
        }

        /* Bot√µes */
        .btn-primary {
            background-color: var(--primary-red);
            color: var(--white);
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            cursor: pointer;
            text-transform: uppercase;
            transition: 0.3s;
        }

        .btn-primary:hover { background-color: #b3050f; transform: scale(1.02); }

        .btn-outline {
            background: transparent;
            color: var(--primary-red);
            border: 2px solid var(--primary-red);
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            width: 100%;
            margin-top: 15px;
            cursor: pointer;
        }

        .btn-voltar { background: #eee; border: 1px solid #ccc; padding: 10px; width: 100%; margin-top: 20px; cursor: pointer; border-radius: 5px; }

        /* Inputs e Selects */
        .input-group { text-align: left; margin-bottom: 15px; width: 100%; }
        .input-group label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; }
        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        /* Dashboard Admin */
        .dashboard-container {
            display: flex;
            width: 100vw;
            height: 100vh;
            background: #f8f9fa;
            position: fixed;
            top: 0; left: 0;
            color: #333;
        }

        .sidebar {
            width: 250px;
            background: #1a1a1a;
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px 0;
        }

        .nav-links { list-style: none; padding: 0; flex-grow: 1; }
        .nav-links li {
            padding: 15px 25px;
            cursor: pointer;
            transition: 0.3s;
            border-left: 4px solid transparent;
        }
        .nav-links li:hover, .nav-links li.active { background: #333; border-left-color: var(--primary-red); }
        .nav-pdf { color: #25D366; font-weight: bold; }

        .admin-content { flex-grow: 1; padding: 30px; overflow-y: auto; }

        /* Grid de Funcion√°rios */
        .grid-nomes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .card-funcionario-admin {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid var(--primary-red);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: 0.2s;
        }
        .card-funcionario-admin:hover { transform: translateY(-3px); background: #fff5f5; }

        /* Tabelas */
        .table-container { background: white; border-radius: 10px; overflow-x: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th { background-color: var(--primary-red); color: white; padding: 12px; }
        td { padding: 12px; border-bottom: 1px solid #ddd; text-align: center; }

        /* Dias da semana em Grid */
        .dias-check {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            background: #eee;
            padding: 10px;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .dashboard-container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; }
            .nav-links { display: flex; flex-wrap: wrap; }
            .nav-links li { padding: 10px; font-size: 12px; flex: 1; text-align: center; }
        }
    </style>
</head>
<body>

<div class="container" id="main-container">
    <div id="tela-perfil" class="card-box">
        <img src="logosansil.png" alt="Sansil" style="width: 180px; margin-bottom: 20px;">
        <button class="btn-primary" onclick="irPara('tela-ponto')" style="height: 80px;">üë§ REGISTRAR PONTO</button>
        <button class="btn-outline" onclick="checarAdmin()">üîë √ÅREA ADMINISTRATIVA</button>
    </div>

    <div id="tela-ponto" class="card-box hidden">
        <h2>ü•ñ Batida de Ponto</h2>
        <div class="input-group">
            <label>Quem √© voc√™?</label>
            <select id="select-func"></select>
        </div>
        <div class="input-group">
            <label>Sua Senha (4 d√≠gitos):</label>
            <input type="password" id="senha-ponto" maxlength="4" inputmode="numeric" placeholder="****">
        </div>
        <div class="input-group">
            <label>O que vai fazer agora?</label>
            <select id="tipo-ponto">
                <option value="Entrada">Entrada (In√≠cio)</option>
                <option value="Sa√≠da p/ Almo√ßo">Sa√≠da p/ Almo√ßo</option>
                <option value="Retorno Almo√ßo">Retorno Almo√ßo</option>
                <option value="Sa√≠da p/ Caf√©">Sa√≠da p/ Caf√©</option>
                <option value="Retorno Caf√©">Retorno Caf√©</option>
                <option value="Sa√≠da (Fim Expediente)">Sa√≠da (Final)</option>
            </select>
        </div>
        <button id="btn-bater-ponto" class="btn-primary" onclick="confirmarPontoSenha()" style="background-color: #28a745;">CONFIRMAR PONTO</button>
        <button class="btn-voltar" onclick="irPara('tela-perfil')">‚Üê Voltar</button>
    </div>

    <div id="tela-admin" class="hidden dashboard-container">
        <nav class="sidebar">
            <div style="text-align: center; padding: 10px;"><img src="logosansil.png" alt="Sansil" style="width: 80px;"></div>
            <ul class="nav-links">
                <li class="active" onclick="mudarAbaAdmin('aba-relatorio')">üìä Relat√≥rios</li>
                <li onclick="mudarAbaAdmin('aba-funcionarios')">üë• Funcion√°rios</li>
                <li onclick="gerarPDF()" class="nav-pdf">üìÑ Gerar PDF</li>
            </ul>
            <button onclick="irPara('tela-perfil')" style="background:none; color:red; border:none; cursor:pointer; font-weight:bold; padding: 20px;">SAIR</button>
        </nav>

        <main class="admin-content">
            <section id="aba-relatorio" class="admin-section">
                <header style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>Relat√≥rios de Ponto</h2>
                    <button onclick="carregarRelatorio()" class="btn-primary" style="width: auto; padding: 10px;">üîÑ Atualizar</button>
                </header>
                
                <div id="container-lista-funcionarios">
                    <div id="lista-nomes-resumo" class="grid-nomes"></div>
                </div>

                <div id="container-detalhes-ponto" class="hidden">
                    <button class="btn-voltar" onclick="voltarParaLista()" style="width: auto; margin-bottom: 15px;">‚¨Ö Voltar para Lista</button>
                    <h3 id="nome-funcionario-selecionado" style="color: var(--primary-red);"></h3>
                    <div class="table-container">
                        <table id="tabela-pontos-admin">
                            <thead>
                                <tr><th>Data</th><th>Entrada</th><th>Alm. Sa√≠da</th><th>Alm. Ret.</th><th>Caf√© Sa√≠da</th><th>Caf√© Ret.</th><th>Sa√≠da</th></tr>
                            </thead>
                            <tbody id="tabela-corpo"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="aba-funcionarios" class="admin-section hidden">
                <h2>Gerenciar Equipe</h2>
                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>‚ûï Novo / Editar</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <input type="text" id="novo-nome" placeholder="Nome Completo">
                        <input type="password" id="novo-senha" maxlength="4" placeholder="Senha PIN">
                        <input type="number" id="id-biometria" placeholder="ID Biometria (Pendrive)">
                        <select id="turno-almoco">
                            <option value="11:00 √†s 12:00">11:00 √†s 12:00</option>
                            <option value="12:00 √†s 13:00">12:00 √†s 13:00</option>
                            <option value="Flex√≠vel">Flex√≠vel</option>
                        </select>
                    </div>
                    <p><strong>Dias de Trabalho:</strong></p>
                    <div class="dias-check">
                        <label><input type="checkbox" class="dia-semana" value="Seg"> Seg</label>
                        <label><input type="checkbox" class="dia-semana" value="Ter"> Ter</label>
                        <label><input type="checkbox" class="dia-semana" value="Qua"> Qua</label>
                        <label><input type="checkbox" class="dia-semana" value="Qui"> Qui</label>
                        <label><input type="checkbox" class="dia-semana" value="Sex"> Sex</label>
                        <label><input type="checkbox" class="dia-semana" value="Sab"> Sab</label>
                        <label><input type="checkbox" class="dia-semana" value="Dom"> Dom</label>
                    </div>
                    <button class="btn-primary" onclick="cadastrarFuncionario()" style="margin-top: 15px;">SALVAR FUNCION√ÅRIO</button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>Nome</th><th>ID Bio</th><th>Almo√ßo</th><th>Dias</th><th>A√ß√µes</th></tr>
                        </thead>
                        <tbody id="tabela-equipe-corpo"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>
</div>

<script>
    let todosOsPontos = []; 
    let funcionarioSelecionado = ""; 
    let idEdicao = null; 

    window.onload = () => { atualizarSelectPonto(); };

    function irPara(idTela) {
        document.getElementById('tela-perfil').classList.add('hidden');
        document.getElementById('tela-ponto').classList.add('hidden');
        document.getElementById('tela-admin').classList.add('hidden');
        document.getElementById(idTela).classList.remove('hidden');
    }

    function checarAdmin() {
        const senha = prompt("Senha administrativa:");
        if (senha === "sansil2026") { 
            irPara('tela-admin');
            mudarAbaAdmin('aba-relatorio');
        } else { alert("Senha incorreta!"); }
    }

    async function confirmarPontoSenha() {
        const nome = document.getElementById('select-func').value;
        const senha = document.getElementById('senha-ponto').value;
        const tipo = document.getElementById('tipo-ponto').value;

        if (!nome || senha.length < 4) return alert("Preencha tudo!");

        try {
            const res = await fetch('/bater-ponto', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ funcionario: nome, senha: senha, tipo: tipo })
            });
            const data = await res.json();
            if(data.success) {
                alert("‚úÖ Ponto registrado!");
                irPara('tela-perfil');
            } else { alert("‚ùå " + data.message); }
        } catch (e) { alert("Erro de conex√£o"); }
    }

    function mudarAbaAdmin(abaId) {
        document.querySelectorAll('.admin-section').forEach(s => s.classList.add('hidden'));
        document.getElementById(abaId).classList.remove('hidden');
        if(abaId === 'aba-relatorio') carregarRelatorio();
        if(abaId === 'aba-funcionarios') listarEquipe();
    }

    async function carregarRelatorio() {
        const res = await fetch('/admin/pontos', { headers: { 'ngrok-skip-browser-warning': 'true' } });
        const data = await res.json();
        todosOsPontos = data.pontos;
        renderizarListaFuncionarios();
    }

    function renderizarListaFuncionarios() {
        voltarParaLista();
        const container = document.getElementById('lista-nomes-resumo');
        container.innerHTML = "";
        const nomesUnicos = [...new Set(todosOsPontos.map(p => p.funcionario))];
        nomesUnicos.forEach(nome => {
            const card = document.createElement('div');
            card.className = "card-funcionario-admin";
            card.innerHTML = `<strong>${nome}</strong>`;
            card.onclick = () => verDetalhesFuncionario(nome);
            container.appendChild(card);
        });
    }

    function verDetalhesFuncionario(nome) {
        funcionarioSelecionado = nome;
        document.getElementById('container-lista-funcionarios').classList.add('hidden');
        document.getElementById('container-detalhes-ponto').classList.remove('hidden');
        document.getElementById('nome-funcionario-selecionado').innerText = "Hist√≥rico: " + nome;
        
        const corpo = document.getElementById('tabela-corpo');
        corpo.innerHTML = "";
        const pontosPorDia = {};

        todosOsPontos.filter(p => p.funcionario === nome).forEach(p => {
            const dataF = new Date(p.data).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
            if (!pontosPorDia[dataF]) pontosPorDia[dataF] = { e: "-", sa: "-", ra: "-", sc: "-", rc: "-", s: "-" };
            
            const t = p.tipo.toLowerCase();
            if (t.includes("entrada")) pontosPorDia[dataF].e = p.hora;
            else if (t.includes("almo√ßo") && t.includes("sa√≠da")) pontosPorDia[dataF].sa = p.hora;
            else if (t.includes("almo√ßo") && t.includes("retorno")) pontosPorDia[dataF].ra = p.hora;
            else if (t.includes("caf√©") && t.includes("sa√≠da")) pontosPorDia[dataF].sc = p.hora;
            else if (t.includes("caf√©") && t.includes("retorno")) pontosPorDia[dataF].rc = p.hora;
            else if (t.includes("sa√≠da") || t.includes("final")) pontosPorDia[dataF].s = p.hora;
        });

        Object.keys(pontosPorDia).sort().reverse().forEach(data => {
            const d = pontosPorDia[data];
            corpo.innerHTML += `<tr><td>${data}</td><td>${d.e}</td><td>${d.sa}</td><td>${d.ra}</td><td>${d.sc}</td><td>${d.rc}</td><td>${d.s}</td></tr>`;
        });
    }

    function voltarParaLista() {
        document.getElementById('container-lista-funcionarios').classList.remove('hidden');
        document.getElementById('container-detalhes-ponto').classList.add('hidden');
    }

    async function listarEquipe() {
        const res = await fetch('/admin/equipe', { headers: { 'ngrok-skip-browser-warning': 'true' } });
        const equipe = await res.json();
        const corpo = document.getElementById('tabela-equipe-corpo');
        corpo.innerHTML = "";
        equipe.forEach(f => {
            corpo.innerHTML += `<tr><td>${f.nome}</td><td>${f.id_biometria || '-'}</td><td>${f.horario_almoco}</td><td>${f.dias_trabalho}</td><td><button onclick="prepararEdicao(${f.id})">‚úèÔ∏è</button></td></tr>`;
        });
    }

    async function cadastrarFuncionario() {
        const nome = document.getElementById('novo-nome').value;
        const senha = document.getElementById('novo-senha').value;
        const idBio = document.getElementById('id-biometria').value;
        const turno = document.getElementById('turno-almoco').value;
        const dias = Array.from(document.querySelectorAll('.dia-semana:checked')).map(c => c.value).join(', ');

        await fetch('/admin/cadastrar-funcionario', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ nome, senha, id_biometria: idBio, turnoAlmoco: turno, diasTrabalho: dias })
        });
        alert("Funcion√°rio salvo!");
        listarEquipe();
        atualizarSelectPonto();
    }

    async function atualizarSelectPonto() {
        const res = await fetch('/admin/equipe', { headers: { 'ngrok-skip-browser-warning': 'true' } });
        const equipe = await res.json();
        const select = document.getElementById('select-func');
        select.innerHTML = '<option value="">Selecione seu nome</option>';
        equipe.forEach(f => { select.innerHTML += `<option value="${f.nome}">${f.nome}</option>`; });
    }

    function gerarPDF() {
        if (!funcionarioSelecionado) return alert("Selecione um funcion√°rio primeiro!");
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        doc.text(`Relat√≥rio de Ponto - ${funcionarioSelecionado}`, 14, 15);
        doc.autoTable({ html: '#tabela-pontos-admin', startY: 20 });
        doc.save(`Ponto_${funcionarioSelecionado}.pdf`);
    }
</script>

</body>
</html>
