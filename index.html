<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ponto - Sansil</title>
    
    <style>
        :root {
            --primary-red: #E30613; 
            --dark-bg: #1a1a1a;
            --light-bg: #f4f4f4;
            --white: #ffffff;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--dark-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: var(--white);
        }

        .container {
            background: var(--white);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 95%;
            max-width: 400px;
            color: #333;
            text-align: center;
        }

        /* Estilo do T√≠tulo */
        h2 {
            color: var(--primary-red);
            text-transform: uppercase;
            font-weight: 900;
            border-bottom: 3px solid var(--primary-red);
            padding-bottom: 10px;
            margin-bottom: 25px;
        }

        .btn-primary {
            background-color: var(--primary-red);
            color: var(--white);
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            cursor: pointer;
            text-transform: uppercase;
            transition: transform 0.2s, background 0.3s;
        }

        .btn-primary:hover { background-color: #b3050f; transform: scale(1.02); }

        .btn-outline {
            background: transparent;
            color: var(--primary-red);
            border: 2px solid var(--primary-red);
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            width: 100%;
            margin-top: 15px;
            cursor: pointer;
        }

        select, input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        /* Dashboard & Sidebar */
        .dashboard-container {
            display: flex;
            width: 100vw;
            height: 100vh;
            background: #f8f9fa;
            position: fixed;
            top: 0; left: 0;
        }

        .sidebar {
            width: 250px;
            background: #1a1a1a;
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px 0;
        }

        .nav-links { list-style: none; padding: 0; flex-grow: 1; }
        .nav-links li {
            padding: 15px 25px;
            cursor: pointer;
            transition: 0.3s;
            border-left: 4px solid transparent;
            text-align: left;
        }
        .nav-links li:hover, .nav-links li.active {
            background: #333;
            border-left-color: var(--primary-red);
        }

        .admin-content { flex-grow: 1; padding: 30px; overflow-y: auto; color: #333; }

        /* Ajustes Mobile e Tabelas */
        .table-container { width: 100%; overflow-x: auto; margin-top: 20px; background: white; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; }
        th { background-color: var(--primary-red); color: white; padding: 12px; }
        td { padding: 12px; border-bottom: 1px solid #ddd; text-align: center; }

        .grid-nomes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .card-funcionario-admin {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid var(--primary-red);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: 0.2s;
        }

        /* Hamb√∫rguer e Menu Mobile */
        .hamburger-btn {
            background: transparent; border: none; cursor: pointer;
            display: flex; flex-direction: column; gap: 5px; padding: 10px;
            z-index: 1001;
        }
        .hamburger-btn span { display: block; width: 25px; height: 3px; background: white; transition: 0.3s; }
        
        .hamburger-btn.open span:nth-child(1) { transform: translateY(8px) rotate(45deg); }
        .hamburger-btn.open span:nth-child(2) { opacity: 0; }
        .hamburger-btn.open span:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }

        .hidden { display: none !important; }
        
        /* Modal de Foto/Biometria */
        .modal-foto {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content { background: white; padding: 20px; border-radius: 15px; width: 90%; max-width: 450px; }

        .dias-check {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
            text-align: left;
        }

        @media (max-width: 768px) {
            .dashboard-container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; display: none; }
            .sidebar.active { display: flex; }
        }
    </style>
</head>
<body>

<div class="container" id="tela-perfil">
    <div class="logo-container">
        <img src="logosansil.png" alt="Sansil Padaria" style="width: 150px; margin-bottom: 10px;">
    </div>
    <button class="btn-primary" onclick="irPara('tela-ponto')" style="height: 80px;">üë§ REGISTRAR PONTO (SENHA)</button>
    <button class="btn-outline" onclick="checarAdmin()">üîë √ÅREA DA DONA (RESTRITO)</button>
</div>

<div class="container hidden" id="tela-ponto">
    <h2>ü•ñ Registro de Ponto</h2>
    <div class="input-group">
        <label>Selecione seu nome:</label>
        <select id="select-func"></select>
    </div>

    <div class="input-group">
        <label>Sua Senha (4 d√≠gitos):</label>
        <input type="password" id="senha-ponto" maxlength="4" inputmode="numeric" placeholder="****">
    </div>

    <div class="input-group">
        <label>O que vai fazer agora?</label>
        <select id="tipo-ponto">
            <option value="Entrada (05:45)">Entrada (In√≠cio de Turno)</option>
            <option value="Sa√≠da p/ Almo√ßo">Sa√≠da p/ Almo√ßo</option>
            <option value="Retorno Almo√ßo">Retorno Almo√ßo</option>
            <option value="Sa√≠da p/ Caf√©">Sa√≠da p/ Caf√©</option>
            <option value="Retorno Caf√©">Retorno Caf√©</option>
            <option value="Sa√≠da (Fim do Expediente)">Sa√≠da (Final do Dia)</option>
        </select>
    </div>

    <button id="btn-bater-ponto" class="btn-primary" onclick="confirmarPontoSenha()" style="background-color: #28a745;">
        CONFIRMAR PONTO
    </button>
    <button class="btn-outline" style="border-color: #ccc; color: #666;" onclick="irPara('tela-perfil')">‚Üê VOLTAR</button>
</div>

<div id="tela-admin" class="hidden dashboard-container">
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header" style="text-align: center; padding: 20px;">
            <img src="logosansil.png" alt="Sansil" style="width: 80px;">
        </div>
        <ul class="nav-links">
            <li class="active" id="btn-aba-relatorio" onclick="mudarAbaAdmin('aba-relatorio')">üìä Relat√≥rios</li>
            <li id="btn-aba-funcionarios" onclick="mudarAbaAdmin('aba-funcionarios')">üë• Funcion√°rios</li>
            <li onclick="gerarPDF()" style="color: #25D366; font-weight: bold;">üìÑ Gerar PDF</li>
        </ul>
        <button class="btn-outline" style="margin: 20px; border-color: #ff4444; color: #ff4444;" onclick="irPara('tela-perfil')">Sair</button>
    </nav>

    <main class="admin-content">
        <header style="display: flex; justify-content: space-between; align-items: center;">
            <button class="hamburger-btn" id="ham-menu" onclick="toggleSidebar()">
                <span></span><span></span><span></span>
            </button>
            <h2 id="titulo-aba" style="margin: 0; border: none;">Painel Sansil</h2>
            <button class="btn-primary" onclick="carregarRelatorio()" style="width: auto; padding: 10px;">üîÑ</button>
        </header>

        <section id="aba-relatorio" class="admin-section">
            <div class="import-box" style="border: 2px dashed #E30613; padding: 20px; border-radius: 10px; margin-bottom: 20px; background: white;">
                <h3>üì• Importar Pendrive</h3>
                <input type="file" id="arquivoBios" accept=".TXT,.dat">
                <button class="btn-primary" onclick="importarArquivo()" style="margin-top: 10px;">Processar Arquivo</button>
            </div>

            <div id="container-lista-funcionarios">
                <div id="lista-nomes-resumo" class="grid-nomes"></div>
            </div>

            <div id="container-detalhes-ponto" class="hidden">
                <button class="btn-outline" onclick="voltarParaLista()" style="width: auto; margin-bottom: 15px;">‚¨Ö Voltar √† Lista</button>
                <h3 id="nome-funcionario-selecionado"></h3>
                <div class="table-container">
                    <table id="tabela-pontos-admin">
                        <thead>
                            <tr><th>Data</th><th>Entrada</th><th>Alm. Sa√≠da</th><th>Alm. Ret.</th><th>Caf√© Sa√≠da</th><th>Caf√© Ret.</th><th>Sa√≠da</th></tr>
                        </thead>
                        <tbody id="tabela-corpo"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="aba-funcionarios" class="admin-section hidden">
            <div class="form-container" style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 id="form-titulo">‚ûï Gerenciar Equipe</h3>
                <input type="text" id="novo-nome" placeholder="Nome Completo">
                <input type="password" id="novo-senha" maxlength="4" placeholder="Senha PIN (4 d√≠gitos)">
                <input type="number" id="id-biometria" placeholder="ID no Aparelho">
                
                <label><strong>Dias de Trabalho:</strong></label>
                <div class="dias-check">
                    <label><input type="checkbox" class="dia-semana" value="Seg"> Seg</label>
                    <label><input type="checkbox" class="dia-semana" value="Ter"> Ter</label>
                    <label><input type="checkbox" class="dia-semana" value="Qua"> Qua</label>
                    <label><input type="checkbox" class="dia-semana" value="Qui"> Qui</label>
                    <label><input type="checkbox" class="dia-semana" value="Sex"> Sex</label>
                    <label><input type="checkbox" class="dia-semana" value="Sab"> Sab</label>
                    <label><input type="checkbox" class="dia-semana" value="Dom"> Dom</label>
                </div>
                <button class="btn-primary" onclick="cadastrarFuncionario()">Salvar Funcion√°rio</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>Nome</th><th>ID Bio</th><th>Dias</th><th>A√ß√µes</th></tr>
                    </thead>
                    <tbody id="tabela-equipe-corpo"></tbody>
                </table>
            </div>
        </section>
    </main>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

<script>
    let todosOsPontos = [];
    let funcionarioSelecionado = "";
    let editandoModo = false;
    let idEdicao = null;

    window.onload = () => { atualizarSelectPonto(); };

    function irPara(idTela) {
        document.querySelectorAll('body > div').forEach(d => {
            if(d.id) d.classList.add('hidden');
        });
        document.getElementById(idTela).classList.remove('hidden');
    }

    function toggleSidebar() {
        const side = document.getElementById('sidebar');
        const btn = document.getElementById('ham-menu');
        side.classList.toggle('active');
        btn.classList.toggle('open');
    }

    async function confirmarPontoSenha() {
        const nome = document.getElementById('select-func').value;
        const senhaDigitada = document.getElementById('senha-ponto').value;
        const tipo = document.getElementById('tipo-ponto').value;

        if (!nome || senhaDigitada.length < 4) return alert("Preencha nome e senha!");

        try {
            const resFunc = await fetch('/admin/equipe');
            const equipe = await resFunc.json();
            const func = equipe.find(f => f.nome === nome);

            if (!func || func.senha !== senhaDigitada) {
                alert("‚ùå SENHA INCORRETA!");
            } else {
                await fetch('/bater-ponto', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ funcionario: nome, tipo: tipo })
                });
                alert("‚úÖ PONTO REGISTRADO!");
                irPara('tela-perfil');
            }
        } catch (e) { alert("Erro de conex√£o."); }
    }

    function checarAdmin() {
        const senha = prompt("Senha administrativa:");
        if (senha === "sansil2026") { 
            irPara('tela-admin');
            mudarAbaAdmin('aba-relatorio');
        }
    }

    function mudarAbaAdmin(abaId) {
        document.querySelectorAll('.admin-section').forEach(s => s.classList.add('hidden'));
        document.getElementById(abaId).classList.remove('hidden');
        document.querySelectorAll('.nav-links li').forEach(li => li.classList.remove('active'));
        document.getElementById('btn-' + abaId).classList.add('active');
        if(abaId === 'aba-relatorio') carregarRelatorio();
        if(abaId === 'aba-funcionarios') listarEquipe();
        if(window.innerWidth < 768) toggleSidebar(); 
    }

    async function carregarRelatorio() {
        const res = await fetch('/admin/pontos');
        const data = await res.json();
        todosOsPontos = data.pontos;
        renderizarListaFuncionarios();
    }

    function renderizarListaFuncionarios() {
        voltarParaLista();
        const container = document.getElementById('lista-nomes-resumo');
        container.innerHTML = "";
        const nomesUnicos = [...new Set(todosOsPontos.map(p => p.funcionario))];
        nomesUnicos.forEach(nome => {
            const card = document.createElement('div');
            card.className = "card-funcionario-admin";
            card.innerHTML = `<strong>${nome}</strong><br><small>Ver hist√≥rico</small>`;
            card.onclick = () => verDetalhesFuncionario(nome);
            container.appendChild(card);
        });
    }

    function verDetalhesFuncionario(nome) {
        funcionarioSelecionado = nome;
        document.getElementById('container-lista-funcionarios').classList.add('hidden');
        document.getElementById('container-detalhes-ponto').classList.remove('hidden');
        document.getElementById('nome-funcionario-selecionado').innerText = nome;
        
        const corpo = document.getElementById('tabela-corpo');
        corpo.innerHTML = "";
        const pontosPorDia = {};

        todosOsPontos.filter(p => p.funcionario === nome).forEach(p => {
            const dataF = new Date(p.data).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
            if (!pontosPorDia[dataF]) pontosPorDia[dataF] = { e: "-", sa: "-", ra: "-", sc: "-", rc: "-", s: "-" };
            
            const t = p.tipo.toLowerCase();
            if (t.includes("entrada")) pontosPorDia[dataF].e = p.hora;
            else if (t.includes("almo√ßo") && t.includes("sa√≠da")) pontosPorDia[dataF].sa = p.hora;
            else if (t.includes("almo√ßo") && t.includes("retorno")) pontosPorDia[dataF].ra = p.hora;
            else if (t.includes("caf√©") && t.includes("sa√≠da")) pontosPorDia[dataF].sc = p.hora;
            else if (t.includes("caf√©") && t.includes("retorno")) pontosPorDia[dataF].rc = p.hora;
            else if (t.includes("sa√≠da") || t.includes("final")) pontosPorDia[dataF].s = p.hora;
        });

        Object.keys(pontosPorDia).sort((a,b) => b.split('/').reverse().join('') - a.split('/').reverse().join('')).forEach(data => {
            const d = pontosPorDia[data];
            corpo.innerHTML += `<tr><td>${data}</td><td>${d.e}</td><td>${d.sa}</td><td>${d.ra}</td><td>${d.sc}</td><td>${d.rc}</td><td>${d.s}</td></tr>`;
        });
    }

    function voltarParaLista() {
        document.getElementById('container-lista-funcionarios').classList.remove('hidden');
        document.getElementById('container-detalhes-ponto').classList.add('hidden');
    }

    async function listarEquipe() {
        const res = await fetch('/admin/equipe');
        const equipe = await res.json();
        const corpo = document.getElementById('tabela-equipe-corpo');
        corpo.innerHTML = "";
        equipe.forEach(f => {
            corpo.innerHTML += `<tr>
                <td>${f.nome}</td>
                <td>${f.id_biometria || '-'}</td>
                <td>${f.dias_trabalho || '-'}</td>
                <td><button class="btn-primary" style="font-size:10px; width: auto;" onclick="prepararEdicao(${f.id}, '${f.nome}')">EDITAR</button></td>
            </tr>`;
        });
    }

    async function atualizarSelectPonto() {
        const res = await fetch('/admin/equipe');
        const equipe = await res.json();
        const select = document.getElementById('select-func');
        select.innerHTML = '<option value="">Selecione seu nome</option>';
        equipe.forEach(f => { select.innerHTML += `<option value="${f.nome}">${f.nome}</option>`; });
    }

    function gerarPDF() {
        if (!funcionarioSelecionado) return alert("Selecione um funcion√°rio!");
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        doc.text(`Relat√≥rio de Ponto - ${funcionarioSelecionado}`, 14, 15);
        doc.autoTable({ html: '#tabela-pontos-admin', startY: 20 });
        doc.save(`Ponto_${funcionarioSelecionado}.pdf`);
    }
</script>
</body>
</html>
